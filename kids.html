<!DOCTYPE html>
<html>
<head>
    <title>Request Something</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#28a745">
    <link rel="manifest" href="kids.json">
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; background-color: #eef2f7; }
        .kid-card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        h1 { color: #2b7de9; margin-bottom: 5px; font-size: 1.8em; }
        h3 { color: #666; margin-bottom: 20px; font-weight: normal; font-size: 1em; }
        input { width: 100%; padding: 15px; font-size: 1.1em; border: 2px solid #ddd; border-radius: 10px; margin-bottom: 15px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; font-size: 1.1em; background: #28a745; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        #status { margin-top: 15px; font-weight: bold; color: #2b7de9; min-height: 20px; font-size: 0.9em; }
        
        /* History Section */
        .history-container { margin-top: 30px; text-align: left; border-top: 1px solid #eee; padding-top: 20px; }
        .history-title { font-size: 0.9em; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .history-list { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; }
        .history-item { padding: 10px; border-bottom: 1px solid #f9f9f9; display: flex; justify-content: space-between; font-size: 0.95em; }
        .history-date { color: #bbb; font-size: 0.8em; }

        #setup-screen, #request-screen { display: none; }
    </style>
</head>
<body>
    <div class="kid-card">
        <div id="setup-screen">
            <h1>Welcome!</h1>
            <h3>Who is using this phone?</h3>
            <input type="text" id="user-name" placeholder="Enter your name">
            <button onclick="saveName()">Save & Start</button>
        </div>

        <div id="request-screen">
            <h1 id="greeting">Hi!</h1>
            <h3>What do you need?</h3>
            <input type="text" id="entry" placeholder="e.g. Apples" onkeydown="if(event.key === 'Enter') sendData()">
            <button onclick="sendData()">Send to Mom</button>
            <div id="status"></div>

            <div class="history-container">
                <div class="history-title">My Recent Requests</div>
                <ul id="my-history" class="history-list">
                    <li>Loading your list...</li>
                </ul>
            </div>

            <p onclick="clearName()" style="margin-top:25px; color:#ccc; font-size:0.7em; cursor:pointer;">(Not your name? Reset here)</p>
        </div>
    </div>

    <script>
        const WEB_APP_URL = "YOUR_GOOGLE_SCRIPT_URL_HERE"; 

        window.onload = function() {
            const savedName = localStorage.getItem('kidName');
            if (savedName) showRequestScreen(savedName);
            else document.getElementById('setup-screen').style.display = 'block';
        };

        function saveName() {
            const name = document.getElementById('user-name').value.trim();
            if (name) { localStorage.setItem('kidName', name); showRequestScreen(name); }
        }

        function showRequestScreen(name) {
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('request-screen').style.display = 'block';
            document.getElementById('greeting').innerText = "Hi, " + name + "!";
            fetchMyHistory();
        }

        function clearName() { 
            if(confirm("Reset name?")) { localStorage.removeItem('kidName'); location.reload(); }
        }

        function toTitleCase(str) { return str.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '); }

        async function fetchMyHistory() {
            const historyList = document.getElementById('my-history');
            const myName = localStorage.getItem('kidName').toLowerCase();
            
            try {
                const response = await fetch(WEB_APP_URL);
                const allData = await response.json();
                
                // Filter for ONLY this kid
                const myItems = allData.filter(item => item.name.toLowerCase() === myName);
                
                if (myItems.length === 0) {
                    historyList.innerHTML = "<li style='color:#ccc; font-size:0.8em;'>No requests yet!</li>";
                    return;
                }

                historyList.innerHTML = myItems.reverse().map(item => `
                    <li class="history-item">
                        <span>${item.item}</span>
                        <span class="history-date">${item.date}</span>
                    </li>
                `).join('');
            } catch (e) {
                historyList.innerHTML = "<li>Couldn't load history.</li>";
            }
        }

        async function sendData() {
            const itemInput = document.getElementById('entry');
            const status = document.getElementById('status');
            const savedName = localStorage.getItem('kidName');
            if(!itemInput.value) return;

            status.innerText = "üöÄ Sending...";
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ 
                        action: "add", 
                        text: toTitleCase(savedName) + " " + toTitleCase(itemInput.value) 
                    })
                });
                status.innerText = "‚úÖ Sent!";
                itemInput.value = "";
                fetchMyHistory(); // Refresh the history list immediately
                setTimeout(() => { status.innerText = ""; }, 3000);
            } catch (e) { status.innerText = "‚ùå Try again!"; }
        }
    </script>
</body>
</html>
